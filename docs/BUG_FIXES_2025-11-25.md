# Bug Fixes - 2025-11-25

## Issues Fixed

### Issue 1: Distracting Console Log Spam
**Problem:** The console was filled with thousands of log entries:
```
ScanProgressDialog::updateProgress called - files: 1234 bytes: 567890 status: 1
```

**Root Cause:** Debug `qDebug()` statement at line 337 in `scan_progress_dialog.cpp` was printing progress updates for every file scanned.

**Solution:** Removed the `qDebug()` statement, keeping only the `LOG_DEBUG` call which respects log level settings.

**Files Modified:**
- `src/gui/scan_progress_dialog.cpp:337-338` - Removed qDebug() statement

---

### Issue 2: Window Position Not Persisting Correctly
**Problem:** Application windows and dialogs were not remembering their last position, or were appearing off-screen after being moved to a second monitor.

**Root Cause:** The `isValidGeometry()` function was too permissive - it accepted windows that barely touched the screen edge (even if 90% was off-screen). This allowed windows positioned at coordinates like (1917, -30) from multi-monitor setups to be considered "valid" and restored to those off-screen positions.

**Solution:** Enhanced the `isValidGeometry()` validation to require at least 50% of the window to be visible on screen. This prevents windows from being restored to positions where they're mostly off-screen.

**Files Modified:**
- `src/core/window_state_manager.cpp:312-334` - Enhanced geometry validation

**Technical Details:**

Before:
```cpp
bool WindowStateManager::isValidGeometry(const QRect& geometry) const
{
    // Check if geometry is within any available screen
    QList<QScreen*> screens = QApplication::screens();
    for (QScreen* screen : screens) {
        QRect screenGeometry = screen->availableGeometry();
        if (screenGeometry.intersects(geometry)) {  // Too permissive!
            return true;
        }
    }
    return false;
}
```

After:
```cpp
bool WindowStateManager::isValidGeometry(const QRect& geometry) const
{
    // Check if geometry is within any available screen
    QList<QScreen*> screens = QApplication::screens();
    for (QScreen* screen : screens) {
        QRect screenGeometry = screen->availableGeometry();

        // CRITICAL FIX: Check if at least 50% of window is visible
        QRect intersection = screenGeometry.intersected(geometry);
        if (!intersection.isEmpty()) {
            int intersectionArea = intersection.width() * intersection.height();
            int windowArea = geometry.width() * geometry.height();

            // Window must have at least 50% visible on screen
            if (windowArea > 0 && intersectionArea >= (windowArea / 2)) {
                return true;
            }
        }
    }
    return false;
}
```

**Behavior:**
- Windows positioned mostly off-screen (multi-monitor coordinates, negative positions) will now be moved to the center of the primary screen
- Windows that are at least 50% visible will keep their position
- Window sizes and maximize state are still preserved correctly

---

### Issue 3: 'Select All' Checkbox Deselect Not Working
**Problem:** In the Results Window, clicking the "Select All" checkbox to uncheck it did not deselect the files. The checkbox would uncheck visually, but all files remained selected.

**Root Cause:** The `selectAllDuplicates()` function was connected to the `toggled` signal, which fires for both check and uncheck events, but the function only handled the "select all" case. It didn't check whether the checkbox was being checked or unchecked.

**Solution:** Changed the signal connection to use a lambda that checks the checkbox state and calls the appropriate function:
- If checked → `selectAllDuplicates()`
- If unchecked → `selectNoneFiles()`

**Files Modified:**
- `src/gui/results_window.cpp:646-652` - Updated checkbox signal connection

**Technical Details:**

Before:
```cpp
// Selection
connect(m_selectAllCheckbox, &QCheckBox::toggled, this, &ResultsWindow::selectAllDuplicates);
// Only handles the "select" case, ignores the "deselect"!
```

After:
```cpp
// Selection - handle both check and uncheck
connect(m_selectAllCheckbox, &QCheckBox::toggled, this, [this](bool checked) {
    if (checked) {
        selectAllDuplicates();
    } else {
        selectNoneFiles();
    }
});
```

**Behavior:**
- Checking "Select All" → Selects all files
- Unchecking "Select All" → Deselects all files
- Both operations now have the performance optimizations (signal blocking) from the previous fix

---

## Testing Verification

### Test Issue #1: Log Spam
1. Run a scan with many files
2. Verify console output is clean
3. Check that progress updates work correctly without spam

### Test Issue #2: Window Position
1. Move a window/dialog to a different position
2. Close the window
3. Reopen the window
4. Verify it appears at the same position (if position is valid)
5. If you have multiple monitors:
   - Move window to second monitor
   - Disconnect second monitor (or change monitor configuration)
   - Reopen application
   - Verify window appears on available screen, not off-screen

### Test Issue #3: Select All Checkbox
1. Open Results Window with duplicate files
2. Click "Select All" checkbox → All files should be selected
3. Click "Select All" checkbox again to uncheck → All files should be deselected
4. Verify both operations are fast (no UI freeze)

---

## Build Information

- **Build completed:** 2025-11-25
- **Build command:** `python3 scripts/build.py --target linux-ninja-cpu --build-type Debug --non-interactive --skip-package`
- **Build successful:** Yes
- **Warnings:** Minor conversion warnings (not errors)

---

## Related Fixes

These fixes complement the previous performance improvements:
- **docs/SELECT_ALL_PERFORMANCE_FIX.md** - Select All/Recommended performance fixes
- **docs/FORCE_QUIT_FIX_2025-11-25.md** - Force Quit dialog fixes

---

## Summary of Changes

| Issue | Component | Severity | Status |
|-------|-----------|----------|--------|
| Console log spam | ScanProgressDialog | Low | ✅ Fixed |
| Window position persistence | WindowStateManager | Medium | ✅ Fixed |
| Select All deselect not working | ResultsWindow | Medium | ✅ Fixed |

All fixes have been compiled and are ready for testing.
